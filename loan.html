<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PACS Utai ‚Äì Loan Profile</title>

  <!-- PRE-AUTH: prevent overlay flash on refresh -->
  <script>
    (function(){
      if (localStorage.getItem('pacs_auth') === '1') {
        document.documentElement.classList.add('authed');
      }
    })();
  </script>

  <link rel="preconnect" href="https://cdn.jsdelivr.net"/>
  <link rel="stylesheet" href="styles.css"/>

  <!-- Chart.js + plugins -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@2.0.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@2.3.0"></script>
</head>

<body>
  <!-- LOGIN OVERLAY -->
  <div id="loginOverlay" class="login-overlay" aria-modal="true" role="dialog">
    <div class="login-card">
      <div class="hd">
        <div style="display:flex;align-items:center;gap:10px">
          <div class="logo" aria-hidden="true" style="background:#fff">
            <img src="https://www.nabard.org/auth/writereaddata/ContentImgs/1303194734NABARD-ENG-logo-big.png" alt="" width="40" height="40" referrerpolicy="no-referrer"/>
          </div>
          <div>
            <div class="ttl" style="color:#145a2a">PACS Utai ‚Äî Sign in</div>
            <div class="meta" style="color:#374151">Durg, Chhattisgarh ‚Ä¢ Established 1982</div>
          </div>
        </div>
      </div>
      <form class="login-body" onsubmit="return handleLogin(event)">
        <div class="login-row">
          <label for="loginId">Login ID</label>
          <input id="loginId" class="login-input" type="text" placeholder="Enter Login ID" autocomplete="username" required/>
        </div>
        <div class="login-row">
          <label for="loginPw">Password</label>
          <input id="loginPw" class="login-input" type="password" placeholder="Enter Password" autocomplete="current-password" required/>
        </div>
        <div class="login-actions">
          <div style="display:flex;align-items:center;gap:8px">
            <button type="submit" class="btn-solid">Sign in</button>
            <button type="button" class="btn-ghost" onclick="document.getElementById('loginPw').type = document.getElementById('loginPw').type==='password'?'text':'password'">Show/Hide</button>
          </div>
          <div id="loginErr" class="login-error">Invalid credentials</div>
        </div>
      </form>
    </div>
  </div>

  <!-- APP -->
  <div class="app-only">
    <div class="appbar">
      <div class="row">
        <a class="logo" href="index.html" aria-label="NABARD">
          <img src="https://www.nabard.org/auth/writereaddata/ContentImgs/1303194734NABARD-ENG-logo-big.png" alt="NABARD logo" width="40" height="40" referrerpolicy="no-referrer"/>
        </a>
        <div>
          <div class="ttl">PACS Utai ‚Äì Executive Snapshot & Drill-downs</div>
          <div class="meta">Durg, Chhattisgarh ‚Ä¢ Established 1982</div>
        </div>
        <div class="welcome">Welcome, <b>Mr. Girdhar Soni, Sachiv ji</b> üôè</div>
      </div>
      <div class="tabs">
        <a class="tab" href="index.html">Snapshot</a>
        <a class="tab" href="pacs.html">PACS profile</a>
        <a class="tab" href="membership.html">Membership</a>
        <a class="tab active" href="loan.html">Loan profile</a>
        <a class="tab" href="noncredit.html">Non-credit</a>
        <a class="tab" href="reporting.html">Reporting</a>
      </div>
    </div>
    <div style="padding:8px 12px">
      <button class="tab" onclick="logout()">Logout</button>
    </div>

    <section class="wrap">
      <!-- ====== CREDIT PENETRATION (single tile with tabs) ====== -->
      <div class="card span-12">
        <div class="hd">
          <div>1) Credit Penetration</div>
          <div class="seg" role="tablist" aria-label="Credit Penetration views">
            <button role="tab" class="active" data-target="cp-members">Members / Borrowers</button>
            <button role="tab" data-target="cp-borrowerpct">Borrower %</button>
            <button role="tab" data-target="cp-land">Land: Owned vs Financed</button>
            <button role="tab" data-target="cp-village">Village-wise view</button>
          </div>
        </div>
        <div class="bd">
          <div class="tiles">
            <div class="kcard"><div class="ic g">üë•</div><div class="kv"><div class="label">Members</div><div class="value" id="kpiMembers">‚Äî</div></div></div>
            <div class="kcard"><div class="ic b">üí≥</div><div class="kv"><div class="label">Borrowers</div><div class="value" id="kpiBorrowers">‚Äî</div></div></div>
            <div class="kcard"><div class="ic a">üìà</div><div class="kv"><div class="label">Borrower %</div><div class="value" id="kpiBorrowerPct">‚Äî%</div></div></div>
            <div class="kcard"><div class="ic t">üåæ</div><div class="kv"><div class="label">Financed / Owned land</div><div class="value" id="kpiLandPct">‚Äî</div></div></div>
          </div>

          <!-- canvases swap via tabs -->
          <div class="chart-wrap tall">
            <canvas id="cpChart"></canvas>
          </div>

          <div class="toolbar">
            <button class="btn" onclick="viewGapDetails()">View gap details</button>
            <button class="btn btn-blue" onclick="initiateMobilization()">Initiate mobilization</button>
            <button class="btn btn-warn" onclick="flagDataIssue()">Flag data issue</button>
            <button class="btn btn-outline" onclick="recommendTopup()">Top-up recommendation</button>
            <button class="btn btn-outline" onclick="exportCoverage()">Download CSV</button>
          </div>
        </div>
      </div>

      <!-- ====== LOAN PORTFOLIO (single tile with tabs) ====== -->
      <div class="card span-12">
        <div class="hd">
          <div>2) Loan Portfolio</div>
          <div class="seg" role="tablist" aria-label="Loan Portfolio views">
            <button role="tab" class="active" data-target="lp-term">KCC / MT / LT</button>
            <button role="tab" data-target="lp-season">KCC: Kharif vs Rabi</button>
            <button role="tab" data-target="lp-insurance">Insurance coverage</button>
            <button role="tab" data-target="lp-ticket">Ticket sizes</button>
            <button role="tab" data-target="lp-enduse">End use split</button>
          </div>
        </div>
        <div class="bd">
          <div class="chart-wrap tall">
            <canvas id="loanChart"></canvas>
          </div>
          <div class="toolbar">
            <button class="btn" onclick="chaseUninsured()">Chase uninsured</button>
            <button class="btn btn-outline" onclick="exportInsurance()">Download Insurance CSV</button>
          </div>
        </div>
      </div>

      <!-- ====== REPAYMENT (single tile with tabs) ====== -->
      <div class="card span-12">
        <div class="hd">
          <div>3) Repayment</div>
          <div class="seg" role="tablist" aria-label="Repayment views">
            <button role="tab" class="active" data-target="rp-cohort">Past cohorts (Rabi/Kharif)</button>
            <button role="tab" data-target="rp-aging">To-be-due aging</button>
            <button role="tab" data-target="rp-dpd">DPD buckets</button>
            <button role="tab" data-target="rp-npa">NPA nomenclature</button>
          </div>
        </div>
        <div class="bd">
          <div class="chart-wrap tall">
            <canvas id="repayChart"></canvas>
          </div>
          <div class="toolbar">
            <button class="btn" onclick="sendReminders()">Send reminders</button>
            <button class="btn btn-outline" onclick="downloadDueList()">Download due list</button>
            <button class="btn btn-warn" onclick="escalate90()">Escalate &gt;90 DPD</button>
            <button class="btn btn-outline" onclick="exportDPD()">Export DPD CSV</button>
          </div>
        </div>
      </div>

      <!-- ====== CONCENTRATION + PEER (two views in one tile) ====== -->
      <div class="card span-12">
        <div class="hd">
          <div>4) Concentration & Peer Benchmarking</div>
          <div class="seg" role="tablist" aria-label="Peer & Concentration views">
            <button role="tab" class="active" data-target="cx-conc">Portfolio Concentration</button>
            <button role="tab" data-target="cx-peer">Peer KPIs</button>
          </div>
        </div>
        <div class="bd">
          <div class="chart-wrap tall">
            <canvas id="cxChart"></canvas>
          </div>
          <div class="toolbar">
            <button class="btn btn-outline" onclick="downloadPeerLoan()">Download peer report</button>
            <button class="btn" onclick="setTargets()">Set improvement targets</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- scripts -->
  <script src="app.js"></script>
  <script src="data.js"></script>
  <script>
    /* ---------- auth gate ---------- */
    ensureAuth();

    /* ---------- helpers ---------- */
    const C = id => document.getElementById(id)?.getContext('2d');

    const valueLabelPlugin = {
      id:'valabel',
      afterDatasetsDraw(chart){
        const {ctx} = chart; ctx.save();
        chart.data.datasets.forEach((ds,dsi)=>{
          const meta=chart.getDatasetMeta(dsi);
          (meta?.data||[]).forEach((el,i)=>{
            const v=ds.data[i]; if(v==null) return;
            const {x,y}=el.tooltipPosition(); ctx.fillStyle='#374151'; ctx.font='12px Inter,Arial'; ctx.textAlign='center';
            ctx.fillText(String(v), x, y-6);
          });
        });
        ctx.restore();
      }
    };

    /* ---------- KPIs ---------- */
    document.getElementById('kpiMembers').textContent   = creditPenetration.members.toLocaleString('en-IN');
    document.getElementById('kpiBorrowers').textContent = creditPenetration.borrowers.toLocaleString('en-IN');
    document.getElementById('kpiBorrowerPct').textContent = Math.round(creditPenetration.borrowers/creditPenetration.members*100) + '%';
    document.getElementById('kpiLandPct').textContent   = Math.round(creditPenetration.landFinanced/creditPenetration.landOwned*100) + '%';

    /* ---------- CHART BUILDERS (swapped by tabs) ---------- */
    let cpChart, loanChart, repayChart, cxChart;

    function buildCP(view){
      const ctx = C('cpChart');
      if (!ctx) return;
      cpChart?.destroy();
      if (view==='cp-members'){
        cpChart = new Chart(ctx,{
          type:'bar',
          data:{labels:['Members','Borrowers'], datasets:[{data:[creditPenetration.members,creditPenetration.borrowers], backgroundColor:['#90caf9','#1976d2']}]},
          options:{responsive:true, plugins:{legend:{display:false}}}, plugins:[valueLabelPlugin]
        });
      } else if (view==='cp-borrowerpct'){
        cpChart = new Chart(ctx,{
          type:'doughnut',
          data:{labels:['Borrowers','Non-borrowers'], datasets:[{data:[
            creditPenetration.borrowers,
            creditPenetration.members - creditPenetration.borrowers
          ], backgroundColor:['#2e7d32','#e5e7eb']}]},
          options:{responsive:true, plugins:{legend:{position:'bottom'}}}
        });
      } else if (view==='cp-land'){
        cpChart = new Chart(ctx,{
          type:'bar',
          data:{labels:coverage.villages, datasets:[
            {label:'Owned (acres)', data:landVsFinanced.owned, backgroundColor:'#90caf9'},
            {label:'KCC-financed (acres)', data:landVsFinanced.financed, backgroundColor:'#1976d2'}
          ]},
          options:{responsive:true, plugins:{legend:{position:'top'}}, scales:{y:{beginAtZero:true}}}, plugins:[valueLabelPlugin]
        });
      } else if (view==='cp-village'){
        // Heatmap village x crop (coverage %)
        const cells=[];
        coverage.crops.forEach((crop,x)=>{
          coverage.villages.forEach((village,y)=>{
            cells.push({x,y,v:coverage.matrix[y][x]});
          });
        });
        cpChart = new Chart(ctx,{
          type:'matrix',
          data:{datasets:[{
            label:'Coverage %',
            data:cells,
            width:({chart})=>(chart.chartArea?.width||0)/(coverage.crops.length+0.2),
            height:({chart})=>(chart.chartArea?.height||0)/(coverage.villages.length+0.2),
            backgroundColor:c=> c.raw.v<40? '#ff8a80' : (c.raw.v<70? '#ffd54f' : '#81c784'),
            borderColor:'#e5e7eb', borderWidth:1
          }]},
          options:{responsive:true, plugins:{legend:{display:false}, tooltip:{callbacks:{
            title:it=> coverage.villages[it[0].raw.y] + ' ‚Ä¢ ' + coverage.crops[it[0].raw.x],
            label:it=> 'Coverage: ' + it.raw.v + '%'
          }}}, scales:{x:{type:'category',labels:coverage.crops,position:'top',grid:{display:false}}, y:{type:'category',labels:coverage.villages,grid:{display:false}}}}
        });
      }
    }

    function buildLoan(view){
      const ctx = C('loanChart');
      if (!ctx) return;
      loanChart?.destroy();
      if (view==='lp-term'){
        loanChart = new Chart(ctx,{type:'doughnut', data:{labels:['KCC','MT','LT'], datasets:[{data:termSplit, backgroundColor:['#2e7d32','#1976d2','#6a4bc3']}]}, options:{plugins:{legend:{position:'bottom'}}}});
      }else if(view==='lp-season'){
        loanChart = new Chart(ctx,{type:'bar', data:{labels:seasonKCC.seasons, datasets:[{label:'KCC Disbursed (‚ÇπL)', data:seasonKCC.disbursed, backgroundColor:'#43a047'}]}, options:{scales:{y:{beginAtZero:true}}}, plugins:[valueLabelPlugin]});
      }else if(view==='lp-insurance'){
        loanChart = new Chart(ctx,{type:'bar', data:{labels:insurance.crops, datasets:[{label:'Coverage %', data:insurance.coveragePct, backgroundColor:insurance.coveragePct.map(p=>p<70?'#ef5350':(p<90?'#ffb74d':'#66bb6a'))}]}, options:{scales:{y:{beginAtZero:true,max:100,ticks:{callback:v=>v+'%'}}}}, plugins:[valueLabelPlugin]});
      }else if(view==='lp-ticket'){
        loanChart = new Chart(ctx,{type:'bar', data:{labels:ticketBuckets.labels, datasets:[{label:'# Loans', data:ticketBuckets.counts, backgroundColor:'#1565c0'}]}, options:{scales:{y:{beginAtZero:true}}}, plugins:[valueLabelPlugin]});
      }else if(view==='lp-enduse'){
        loanChart = new Chart(ctx,{type:'pie', data:{labels:endUse.labels, datasets:[{data:endUse.shares, backgroundColor:['#2e7d32','#009688','#ffb300','#6a4bc3','#c62828']}]} , options:{plugins:{legend:{position:'bottom'}}}});
      }
    }

    function buildRepay(view){
      const ctx = C('repayChart');
      if (!ctx) return;
      repayChart?.destroy();
      if (view==='rp-cohort'){
        repayChart = new Chart(ctx,{type:'bar', data:{labels:cohort.labels, datasets:[
          {label:'On-time %', data:cohort.onTime, backgroundColor:'#2e7d32', stack:'s'},
          {label:'Delayed %', data:cohort.delayed, backgroundColor:'#ffb300', stack:'s'},
          {label:'Default %', data:cohort.defaulted, backgroundColor:'#c62828', stack:'s'}
        ]}, options:{scales:{y:{beginAtZero:true,max:100,ticks:{callback:v=>v+'%'}}}}, plugins:[valueLabelPlugin]});
      }else if(view==='rp-aging'){
        repayChart = new Chart(ctx,{type:'bar', data:{labels:aging.labels, datasets:[{label:'Amount (‚ÇπL)', data:aging.amountLakh, backgroundColor:'#1976d2'}]}, options:{scales:{y:{beginAtZero:true}}}, plugins:[valueLabelPlugin]});
      }else if(view==='rp-dpd'){
        repayChart = new Chart(ctx,{type:'bar', data:{labels:dpdBuckets.labels, datasets:[{label:'Overdue (‚ÇπL)', data:dpdBuckets.amountLakh, backgroundColor:['#66bb6a','#ffb74d','#fb8c00','#c62828']}]} , options:{scales:{y:{beginAtZero:true}}}, plugins:[valueLabelPlugin]});
      }else if(view==='rp-npa'){
        repayChart = new Chart(ctx,{type:'bar', data:{labels:npa.labels, datasets:[{label:'Outstanding (‚ÇπL)', data:npa.amountLakh, backgroundColor:'#6a4bc3'}]}, options:{scales:{y:{beginAtZero:true}}}, plugins:[valueLabelPlugin]});
      }
    }

    function buildCX(view){
      const ctx = C('cxChart');
      if (!ctx) return;
      cxChart?.destroy();
      if (view==='cx-conc'){
        cxChart = new Chart(ctx,{type:'treemap', data:{datasets:[{
          tree: concentration.data.map(d=>({category:d.name, value:d.share})),
          key:'value',
          labels:{display:true, formatter:ctx=> `${ctx.raw.category}\n${ctx.raw.value}%`},
          backgroundColor:ctx=> ctx.raw.value>25 ? '#ef5350' : '#90caf9',
          borderColor:'#fff', borderWidth:2, spacing:0.5
        }]} , options:{plugins:{legend:{display:false}}}});
      } else {
        cxChart = new Chart(ctx,{type:'bar', data:{labels:peerVillages, datasets:[
          {label:'Avg ticket (‚Çπk)', data:avgTicket, backgroundColor:'#1976d2'},
          {type:'line', label:'Repayment %', data:repayPct, borderColor:'#2e7d32', pointRadius:4, tension:.35, yAxisID:'y1'}
        ]}, options:{scales:{y:{beginAtZero:true,title:{display:true,text:'‚Çπ thousands'}}, y1:{position:'right',beginAtZero:true,grid:{drawOnChartArea:false},ticks:{callback:v=>v+' %'},title:{display:true,text:'Repayment %'}}}});
      }
    }

    /* ---------- tab wiring ---------- */
    function wireTabs(){
      document.querySelectorAll('.seg').forEach(seg=>{
        seg.addEventListener('click', e=>{
          const btn = e.target.closest('button[role="tab"]'); if(!btn) return;
          seg.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          const target = btn.dataset.target;
          if (target.startsWith('cp-')) buildCP(target);
          else if (target.startsWith('lp-')) buildLoan(target);
          else if (target.startsWith('rp-')) buildRepay(target);
          else if (target.startsWith('cx-')) buildCX(target);
        });
      });
    }

    // initial views
    buildCP('cp-members');
    buildLoan('lp-term');
    buildRepay('rp-cohort');
    buildCX('cx-conc');
    wireTabs();

    /* ---------- CTAs (demo) ---------- */
    window.viewGapDetails = () => alert('Opens drill-down of underfinanced farmers by village √ó crop (demo).');
    window.initiateMobilization = () => alert('Assign field officer & SMS campaign to red/amber cells (demo).');
    window.flagDataIssue = () => alert('Flagged for data correction (demo).');
    window.recommendTopup = () => alert('Top-up recommendation generated (demo).');
    window.exportCoverage = () => {
      const rows=[['Village','Crop','Coverage %']];
      coverage.villages.forEach((v,ri)=> coverage.crops.forEach((c,ci)=> rows.push([v,c,coverage.matrix[ri][ci]])));
      downloadCSV('coverage_heatmap.csv',rows);
    };
    window.chaseUninsured = () => alert('Uninsured KCC list generated (demo).');
    window.exportInsurance = () => {
      const rows=[['Crop','Coverage %']]; insurance.crops.forEach((c,i)=>rows.push([c,insurance.coveragePct[i]]));
      downloadCSV('insurance_coverage.csv',rows);
    };
    window.sendReminders = () => alert('Reminder SMS/WA queued (demo).');
    window.downloadDueList = () => {
      const rows=[['Bucket','Amount (‚ÇπL)']]; aging.labels.forEach((b,i)=>rows.push([b,aging.amountLakh[i]]));
      downloadCSV('to_be_due_aging.csv',rows);
    };
    window.escalate90 = () => alert('Escalation note prepared for >90 DPD (demo).');
    window.exportDPD = () => {
      const rows=[['DPD Bucket','Amount (‚ÇπL)']]; dpdBuckets.labels.forEach((b,i)=>rows.push([b,dpdBuckets.amountLakh[i]]));
      downloadCSV('dpd_buckets.csv',rows);
    };
    window.downloadPeerLoan = () => {
      const rows=[['Peer','Avg ticket (‚Çπk)','Repayment %']]; peerVillages.forEach((p,i)=>rows.push([p,avgTicket[i],repayPct[i]]));
      downloadCSV('peer_benchmarking.csv',rows);
    };
    window.setTargets = () => alert('Targets set for low-performing peers/villages (demo).');
  </script>
</body>
</html>
