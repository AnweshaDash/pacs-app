<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>PACS Utai ‚Äì Loan Profile</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net"/>
<link rel="stylesheet" href="styles.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
</head>
<body class="app-only app-locked">
<!-- LOGIN OVERLAY -->
<div id="loginOverlay" class="login-overlay" aria-modal="true" role="dialog">
  <div class="login-card">
    <div class="hd">
      <div style="display:flex;align-items:center;gap:10px">
        <div class="logo" aria-hidden="true" style="background:#fff">
          <img src="https://www.nabard.org/auth/writereaddata/ContentImgs/1303194734NABARD-ENG-logo-big.png" alt="" loading="lazy" width="40" height="40" referrerpolicy="no-referrer"/>
        </div>
        <div>
          <div class="ttl" style="color:#145a2a">PACS Utai ‚Äî Sign in</div>
          <div class="meta" style="color:#374151">Durg, Chhattisgarh ‚Ä¢ Established 1982</div>
        </div>
      </div>
    </div>
    <form class="login-body" onsubmit="return handleLogin(event)">
      <div class="login-row">
        <label for="loginId">Login ID</label>
        <input id="loginId" class="login-input" type="text" placeholder="Enter Login ID" autocomplete="username" required/>
      </div>
      <div class="login-row">
        <label for="loginPw">Password</label>
        <input id="loginPw" class="login-input" type="password" placeholder="Enter Password" autocomplete="current-password" required/>
      </div>
      <div class="login-actions">
        <div style="display:flex;align-items:center;gap:8px">
          <button type="submit" class="btn-solid">Sign in</button>
          <button type="button" class="btn-ghost" onclick="document.getElementById('loginPw').type = document.getElementById('loginPw').type==='password'?'text':'password'">Show/Hide</button>
        </div>
        <div id="loginErr" class="login-error">Invalid credentials</div>
      </div>
    </form>
  </div>
</div>

<!-- APP -->
<div class="app-only">
  <div class="appbar">
    <div class="row">
      <a class="logo" href="index.html" aria-label="NABARD">
        <img src="https://www.nabard.org/auth/writereaddata/ContentImgs/1303194734NABARD-ENG-logo-big.png" alt="NABARD logo" loading="lazy" width="40" height="40" referrerpolicy="no-referrer"/>
      </a>
      <div>
        <div class="ttl">PACS Utai ‚Äì Executive Snapshot & Drill-downs</div>
        <div class="meta">Durg, Chhattisgarh ‚Ä¢ Established 1982</div>
      </div>
      <div class="welcome">Welcome, <b>Mr. Girdhar Soni, Sachiv ji</b> üôè</div>
    </div>
    <div class="tabs">
      <a class="tab" href="index.html">Snapshot</a>
      <a class="tab" href="pacs.html">PACS profile</a>
      <a class="tab" href="membership.html">Membership</a>
      <a class="tab active" href="loan.html">Loan profile</a>
      <a class="tab" href="noncredit.html">Non-credit</a>
      <a class="tab" href="reporting.html">Reporting</a>
    </div>
  </div>
  <div style="padding:8px 12px">
    <button class="tab" onclick="logout()">Logout</button>
  </div>

  <!-- LOAN PROFILE CONTENT -->
  <section class="wrap">
    <div class="grid">
      <!-- Card 1: Utilisation -->
      <div class="card span-6">
        <div class="hd">Loan Utilization (Land vs KCC Covered) <span class="pill">Target ‚â•70%</span></div>
        <div class="bd">
          <div class="chart-wrap"><canvas id="utilChart"></canvas></div>
          <div class="hint" style="margin-top:6px">Utilization (%) = (KCC-covered cultivable acres √∑ Total cultivable acres) √ó 100. Low utilization ‚áí under-financed.</div>
          <div class="insights" id="utilInsights"></div>
          <div class="toolbar">
            <button class="tab" onclick="findTopup()">Find top-up candidates</button>
            <button class="tab" onclick="exportUtilization()">Download utilization CSV</button>
          </div>
        </div>
      </div>

      <!-- Card 2: Upcoming vs Overdue -->
      <div class="card span-6">
        <div class="hd">Repayment Monitoring (Upcoming vs Overdue)</div>
        <div class="bd">
          <div class="chart-wrap"><canvas id="repayChart"></canvas></div>
          <div class="insights" id="repayInsights"></div>
          <div class="toolbar">
            <button class="tab" onclick="sendReminders()">Send reminders</button>
            <button class="tab" onclick="downloadDueList()">Download due list</button>
            <button class="tab" style="color:#c62828" onclick="escalate90()">Escalate &gt;90 DPD</button>
          </div>
        </div>
      </div>

      <!-- Card 3: DPD by village -->
      <div class="card span-6">
        <div class="hd">Overdue & DPD Monitoring <span class="pill">DPD = Days Past Due</span></div>
        <div class="bd">
          <div class="chart-wrap"><canvas id="dpdVillageChart"></canvas></div>
          <div class="insights" id="dpdInsights"></div>
          <div class="toolbar">
            <button class="tab" onclick="sendRepaymentNudges()">Send repayment nudges</button>
            <button class="tab" onclick="exportOverdue()">Export overdue CSV</button>
          </div>
        </div>
      </div>

      <!-- Card 4: Peer benchmarking -->
      <div class="card span-6">
        <div class="hd">Peer Benchmarking (Branches / Villages)</div>
        <div class="bd">
          <div class="chart-wrap"><canvas id="peerLoanChart"></canvas></div>
          <div class="insights" id="peerLoanInsights"></div>
          <div class="toolbar">
            <button class="tab" onclick="downloadPeerLoan()">Download benchmarking report</button>
            <button class="tab" onclick="setTargets()">Set improvement targets</button>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- scripts -->
<script src="app.js"></script>
<script src="data.js"></script>
<script>
  // lock/unlock
  ensureAuth();

  // helpers
  const ctx = id => document.getElementById(id)?.getContext('2d');
  const fmt = n => Number(n).toLocaleString('en-IN');

  // small value-label plugin
  const valueLabelPlugin = {
    id:'valabel',
    afterDatasetsDraw(chart){
      const {ctx} = chart; ctx.save();
      chart.data.datasets.forEach((ds, dsi)=>{
        const meta = chart.getDatasetMeta(dsi);
        (meta?.data||[]).forEach((el,i)=>{
          const v = ds.data[i]; if(v==null) return;
          const {x,y}=el.tooltipPosition();
          ctx.font = '12px Inter, Arial';
          ctx.fillStyle = '#374151';
          ctx.textAlign='center';
          ctx.fillText(String(v), x, y-6);
        });
      });
      ctx.restore();
    }
  };

  /* --------- Charts --------- */

  // 1) Utilisation
  if (ctx('utilChart')) {
    const utilChart = new Chart(ctx('utilChart'), {
      type:'bar',
      data:{
        labels: utilRaw.labels,
        datasets:[
          {type:'bar', label:'Utilization %', data: utilizationPct, backgroundColor:'#1976d2', order:2},
          {type:'line', label:'Target (‚â•70%)', data: utilizationPct.map(()=>70), borderColor:'#ffb300', borderDash:[6,6], borderWidth:2, pointRadius:0, tension:0, order:1}
        ]
      },
      options:{responsive:true, plugins:{legend:{position:'top'}}, scales:{y:{beginAtZero:true, max:100, ticks:{callback:v=>v+'%'}}}},
      plugins:[valueLabelPlugin]
    });
    const under = utilRaw.labels.filter((l,i)=> utilizationPct[i] < 70);
    document.getElementById('utilInsights').innerHTML =
      `‚Ä¢ Under target in: <b>${under.join(', ') || '‚Äî'}</b>. Prioritise top-ups and re-check non-financeable land tags.`;
  }

  // 2) Repayment monitoring
  if (ctx('repayChart')) {
    new Chart(ctx('repayChart'),{
      type:'bar',
      data:{labels:repayment.months, datasets:[
        {label:'Upcoming dues (members)', data:repayment.upcoming, backgroundColor:'#43a047'},
        {label:'Overdue (members)', data:repayment.overdue, backgroundColor:'#c62828'}
      ]},
      options:{responsive:true, plugins:{legend:{position:'top'}}},
      plugins:[valueLabelPlugin]
    });
    const hot = repayment.months[repayment.overdue.indexOf(Math.max(...repayment.overdue))];
    document.getElementById('repayInsights').innerHTML =
      `‚Ä¢ Peak overdue expected in <b>${hot}</b>. Queue nudges first for that cohort.`;
  }

  // 3) DPD by village
  if (ctx('dpdVillageChart')) {
    new Chart(ctx('dpdVillageChart'),{
      type:'bar',
      data:{labels:dpdByVillage.labels, datasets:[
        {label:'>30 DPD (members)', data:dpdByVillage.d30, backgroundColor:'#66bb6a'},
        {label:'>60 DPD (members)', data:dpdByVillage.d60, backgroundColor:'#ffb300'},
        {label:'>90 DPD (members)', data:dpdByVillage.d90, backgroundColor:'#c62828'}
      ]},
      options:{responsive:true, plugins:{legend:{position:'top'}}, scales:{y:{beginAtZero:true}}},
      plugins:[valueLabelPlugin]
    });
    const worst = dpdByVillage.labels
      .map((v,i)=>({v, score: dpdByVillage.d90[i]*2 + dpdByVillage.d60[i]}))
      .sort((a,b)=>b.score-a.score)
      .map(w=>w.v)
      .join(' ‚Üí ');
    document.getElementById('dpdInsights').innerHTML =
      `‚Ä¢ Chronic overdue focus order: <b>${worst}</b>. Escalate >90 first, then 60.`;
  }

  // 4) Peer benchmarking
  if (ctx('peerLoanChart')) {
    new Chart(ctx('peerLoanChart'),{
      type:'bar',
      data:{labels:peerVillages, datasets:[
        {label:'Avg ticket (‚Çπk)', data:avgTicket, backgroundColor:'#1976d2'},
        {type:'line', label:'Repayment %', data:repayPct, borderColor:'#2e7d32', pointRadius:4, tension:.35, yAxisID:'y1'}
      ]},
      options:{responsive:true, scales:{
        y:{beginAtZero:true, title:{display:true,text:'‚Çπ thousands'}},
        y1:{position:'right', beginAtZero:true, grid:{drawOnChartArea:false}, ticks:{callback:v=>v+' %'}, title:{display:true,text:'Repayment %'}}
      }},
      plugins:[valueLabelPlugin]
    });
    const best = peerVillages[repayPct.indexOf(Math.max(...repayPct))];
    document.getElementById('peerLoanInsights').innerHTML =
      `‚Ä¢ Best repayment: <b>${best}</b>. Set ticket targets after stabilising collections in weaker villages.`;
  }

  /* --------- Page-local actions / CSV exports --------- */
  function downloadCSV(filename, rows){
    const processRow = row => row.map(v => `"${(v??'').toString().replace(/"/g,'""')}"`).join(',');
    const csv = rows.map(processRow).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download=filename; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  }

  // toolbar handlers (local to this page)
  window.findTopup = () => alert('Identified under-financed cultivable land; top-up candidates queued (demo).');
  window.exportUtilization = () => {
    const rows=[['Village','Cultivable acres','KCC-covered acres','Utilisation %']];
    utilRaw.labels.forEach((l,i)=>rows.push([l,utilRaw.cultivable[i],utilRaw.kccCovered[i],utilizationPct[i]]));
    downloadCSV('utilisation.csv',rows);
  };
  window.sendReminders = () => alert('Reminder SMS/WA queued to members with upcoming dues (demo).');
  window.downloadDueList = () => {
    const rows=[['Month','Upcoming members','Overdue members']];
    repayment.months.forEach((m,i)=>rows.push([m,repayment.upcoming[i],repayment.overdue[i]]));
    downloadCSV('duelist.csv',rows);
  };
  window.escalate90 = () => alert('Escalation note prepared for >90 DPD (demo).');
  window.sendRepaymentNudges = () => alert('Repayment nudges sent to >30 DPD cohort (demo).');
  window.exportOverdue = () => {
    const rows=[['Village','>30 DPD','>60 DPD','>90 DPD']];
    dpdByVillage.labels.forEach((l,i)=>rows.push([l,dpdByVillage.d30[i],dpdByVillage.d60[i],dpdByVillage.d90[i]]));
    downloadCSV('overdue_by_village.csv',rows);
  };
  window.downloadPeerLoan = () => {
    const rows=[['PACS/Village','Avg ticket (‚Çπk)','Repayment %']];
    peerVillages.forEach((p,i)=>rows.push([p,avgTicket[i],repayPct[i]]));
    downloadCSV('loan_benchmarking.csv',rows);
  };
  window.setTargets = () => alert('Targets set for low-performing villages with monthly review (demo).');
</script>
</body>
</html>
