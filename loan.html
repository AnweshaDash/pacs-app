<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>PACS Utai ‚Äì Loan Profile</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net"/>
<link rel="stylesheet" href="styles.css"/>

<!-- Chart.js core -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<!-- Plugins used on this page -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@2.0.1"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@2.3.0"></script>
</head>

<body class="app-only app-locked">
<!-- LOGIN OVERLAY (kept as-is) -->
<div id="loginOverlay" class="login-overlay" aria-modal="true" role="dialog">
  <div class="login-card">
    <div class="hd">
      <div style="display:flex;align-items:center;gap:10px">
        <div class="logo" aria-hidden="true" style="background:#fff">
          <img src="https://www.nabard.org/auth/writereaddata/ContentImgs/1303194734NABARD-ENG-logo-big.png" alt="" loading="lazy" width="40" height="40" referrerpolicy="no-referrer"/>
        </div>
        <div>
          <div class="ttl" style="color:#145a2a">PACS Utai ‚Äî Sign in</div>
          <div class="meta" style="color:#374151">Durg, Chhattisgarh ‚Ä¢ Established 1982</div>
        </div>
      </div>
    </div>
    <form class="login-body" onsubmit="return handleLogin(event)">
      <div class="login-row">
        <label for="loginId">Login ID</label>
        <input id="loginId" class="login-input" type="text" placeholder="Enter Login ID" autocomplete="username" required/>
      </div>
      <div class="login-row">
        <label for="loginPw">Password</label>
        <input id="loginPw" class="login-input" type="password" placeholder="Enter Password" autocomplete="current-password" required/>
      </div>
      <div class="login-actions">
        <div style="display:flex;align-items:center;gap:8px">
          <button type="submit" class="btn-solid">Sign in</button>
          <button type="button" class="btn-ghost" onclick="document.getElementById('loginPw').type = document.getElementById('loginPw').type==='password'?'text':'password'">Show/Hide</button>
        </div>
        <div id="loginErr" class="login-error">Invalid credentials</div>
      </div>
    </form>
  </div>
</div>

<!-- APP -->
<div class="app-only">
  <div class="appbar">
    <div class="row">
      <a class="logo" href="index.html" aria-label="NABARD">
        <img src="https://www.nabard.org/auth/writereaddata/ContentImgs/1303194734NABARD-ENG-logo-big.png" alt="NABARD logo" loading="lazy" width="40" height="40" referrerpolicy="no-referrer"/>
      </a>
      <div>
        <div class="ttl">PACS Utai ‚Äì Executive Snapshot & Drill-downs</div>
        <div class="meta">Durg, Chhattisgarh ‚Ä¢ Established 1982</div>
      </div>
      <div class="welcome">Welcome, <b>Mr. Girdhar Soni, Sachiv ji</b> üôè</div>
    </div>
    <div class="tabs">
      <a class="tab" href="index.html">Snapshot</a>
      <a class="tab" href="pacs.html">PACS profile</a>
      <a class="tab" href="membership.html">Membership</a>
      <a class="tab active" href="loan.html">Loan profile</a>
      <a class="tab" href="noncredit.html">Non-credit</a>
      <a class="tab" href="reporting.html">Reporting</a>
    </div>
  </div>
  <div style="padding:8px 12px">
    <button class="tab" onclick="logout()">Logout</button>
  </div>

  <!-- ====================== LOAN PROFILE ====================== -->
  <section class="wrap">

    <!-- ========== Bucket 1: Credit Penetration ========== -->
    <h2 class="bucket">1) Credit Penetration</h2>
    <div class="grid">
      <div class="kcard span-3"><div class="ic g">üë•</div><div class="kv"><div class="label">Members</div><div class="value" id="lp_members">‚Äî</div></div></div>
      <div class="kcard span-3"><div class="ic b">üí≥</div><div class="kv"><div class="label">Borrowers</div><div class="value" id="lp_borrowers">‚Äî</div></div></div>
      <div class="kcard span-3"><div class="ic a">üìà</div><div class="kv"><div class="label">Borrower %</div><div class="value" id="lp_borrower_pct">‚Äî%</div></div></div>
      <div class="kcard span-3"><div class="ic t">üåæ</div><div class="kv"><div class="label">Financed land / Owned</div><div class="value" id="lp_land_ratio">‚Äî</div><div class="mini">KCC-covered acres vs owned (borrowers)</div></div></div>

      <!-- Heatmap: village √ó crop coverage -->
      <div class="card span-7">
        <div class="hd">Credit Absorption & Utilization <span class="pill">Coverage % by Village √ó Crop</span></div>
        <div class="bd">
          <div class="legend-row">
            <span class="legend-dot red"></span><span class="tiny">0‚Äì40% (Gap)</span>
            <span class="legend-dot amber"></span><span class="tiny">40‚Äì70% (Partial)</span>
            <span class="legend-dot green"></span><span class="tiny">70‚Äì100% (Adequate)</span>
          </div>
          <div class="chart-wrap"><canvas id="coverageHeatmap"></canvas></div>
          <div class="toolbar">
            <button class="btn" onclick="viewGapDetails()">View gap details</button>
            <button class="btn btn-blue" onclick="initiateMobilization()">Initiate mobilization</button>
            <button class="btn btn-warn" onclick="flagDataIssue()">Flag data issue</button>
            <button class="btn btn-outline" onclick="recommendTopup()">Top-up recommendation</button>
            <button class="btn btn-outline" onclick="exportCoverage()">Download CSV</button>
          </div>
        </div>
      </div>

      <!-- Stacked bars: land owned vs financed -->
      <div class="card span-5">
        <div class="hd">Borrowers ‚Äì Land Owned vs Financed</div>
        <div class="bd">
          <div class="chart-wrap"><canvas id="landChart"></canvas></div>
          <div class="insights" id="landInsights"></div>
        </div>
      </div>
    </div>

    <!-- ========== Bucket 2: Loan Portfolio ========== -->
    <h2 class="bucket">2) Loan Portfolio</h2>
    <div class="grid">
      <div class="card span-4">
        <div class="hd">Term Split ‚Äì KCC / MT / LT</div>
        <div class="bd"><div class="chart-wrap"><canvas id="termSplit"></canvas></div></div>
      </div>
      <div class="card span-4">
        <div class="hd">KCC ‚Äì Rabi vs Kharif</div>
        <div class="bd"><div class="chart-wrap"><canvas id="seasonSplit"></canvas></div></div>
      </div>
      <div class="card span-4">
        <div class="hd">KCC ‚Äì Insurance Coverage</div>
        <div class="bd">
          <div class="chart-wrap"><canvas id="insuranceChart"></canvas></div>
          <div class="toolbar">
            <button class="btn" onclick="chaseUninsured()">Chase uninsured</button>
            <button class="btn btn-outline" onclick="exportInsurance()">Download CSV</button>
          </div>
        </div>
      </div>

      <div class="card span-6">
        <div class="hd">KCC ‚Äì Ticket Sizes</div>
        <div class="bd"><div class="chart-wrap"><canvas id="ticketChart"></canvas></div>
          <div class="insights">Buckets: &lt;50k, 50k‚Äì1L, 1‚Äì2L, 2‚Äì3L, 3L+ (‚Çπ).</div>
        </div>
      </div>

      <div class="card span-6">
        <div class="hd">KCC ‚Äì End Use</div>
        <div class="bd"><div class="chart-wrap"><canvas id="endUseChart"></canvas></div></div>
      </div>
    </div>

    <!-- ========== Bucket 3: Repayment Related ========== -->
    <h2 class="bucket">3) Repayment Related</h2>
    <div class="grid">
      <div class="card span-6">
        <div class="hd">Repayment ‚Äì Past Cohorts (Rabi & Kharif)</div>
        <div class="bd">
          <div class="chart-wrap"><canvas id="cohortRepay"></canvas></div>
          <div class="insights">On-time / Delayed / Defaulted by season-year cohort at harvest/12-month mark.</div>
        </div>
      </div>

      <div class="card span-6">
        <div class="hd">Current Cycle ‚Äì To-be-Due Aging</div>
        <div class="bd">
          <div class="chart-wrap"><canvas id="agingChart"></canvas></div>
          <div class="insights">Upcoming: &lt;15d ‚Ä¢ 15‚Äì30d ‚Ä¢ 30‚Äì60d ‚Ä¢ 60+d (‚Çπ).</div>
          <div class="toolbar">
            <button class="btn" onclick="sendReminders()">Send reminders</button>
            <button class="btn btn-outline" onclick="downloadDueList()">Download due list</button>
          </div>
        </div>
      </div>

      <div class="card span-6">
        <div class="hd">Current Cycle ‚Äì DPD Buckets</div>
        <div class="bd">
          <div class="chart-wrap"><canvas id="dpdBucketsChart"></canvas></div>
          <div class="toolbar">
            <button class="btn btn-warn" onclick="escalate90()">Escalate &gt;90 DPD</button>
            <button class="btn btn-outline" onclick="exportDPD()">Export DPD CSV</button>
          </div>
        </div>
      </div>

      <div class="card span-6">
        <div class="hd">Regulatory NPA Nomenclature</div>
        <div class="bd">
          <div class="chart-wrap"><canvas id="npaChart"></canvas></div>
          <div class="insights">SMA-0, SMA-1, SMA-2, NPA-Substandard, Doubtful, Loss.</div>
        </div>
      </div>
    </div>

    <!-- ========== Other relevant aspect ========== -->
    <h2 class="bucket">4) Concentration & Peer</h2>
    <div class="grid">
      <div class="card span-6">
        <div class="hd">Concentration ‚Äì Crop/Village</div>
        <div class="bd">
          <div class="chart-wrap"><canvas id="concentrationTreemap"></canvas></div>
          <div class="insights">Red tiles exceed 25% threshold. Download list to target diversification.</div>
        </div>
      </div>

      <div class="card span-6">
        <div class="hd">Peer Benchmarking (Avg Ticket & Repayment)</div>
        <div class="bd">
          <div class="chart-wrap"><canvas id="peerLoanChart"></canvas></div>
          <div class="toolbar">
            <button class="btn btn-outline" onclick="downloadPeerLoan()">Download benchmarking report</button>
            <button class="btn" onclick="setTargets()">Set improvement targets</button>
          </div>
        </div>
      </div>
    </div>

  </section>
</div>

<!-- scripts -->
<script src="app.js"></script>
<script src="data.js"></script>
<script>
  /* ------ Lock/Unlock (uses your existing app.js helpers) ------ */
  ensureAuth();

  /* ------ Local helpers ------ */
  const C = (id)=>document.getElementById(id)?.getContext('2d');
  const fmt = n => Number(n).toLocaleString('en-IN');

  // value labels
  const valueLabelPlugin = {
    id:'valabel',
    afterDatasetsDraw(chart){
      const {ctx} = chart; ctx.save();
      chart.data.datasets.forEach((ds,dsi)=>{
        const meta=chart.getDatasetMeta(dsi);
        (meta?.data||[]).forEach((el,i)=>{
          const v=ds.data[i]; if(v==null) return;
          const {x,y}=el.tooltipPosition(); ctx.fillStyle='#374151'; ctx.font='12px Inter,Arial'; ctx.textAlign='center';
          ctx.fillText(String(v), x, y-6);
        });
      });
      ctx.restore();
    }
  };

  /* ------ KPIs ------ */
  document.getElementById('lp_members').textContent   = fmt(creditPenetration.members);
  document.getElementById('lp_borrowers').textContent = fmt(creditPenetration.borrowers);
  document.getElementById('lp_borrower_pct').textContent = Math.round(creditPenetration.borrowers/creditPenetration.members*100)+'%';
  document.getElementById('lp_land_ratio').textContent   = Math.round(creditPenetration.landFinanced/creditPenetration.landOwned*100)+'%';

  /* ------ Charts ------ */

  // 1a) Heatmap Coverage (Village √ó Crop)
  if (C('coverageHeatmap')) {
    const cells = [];
    coverage.crops.forEach((crop, x)=>{
      coverage.villages.forEach((village, y)=>{
        const pct = coverage.matrix[y][x]; // row=vil, col=crop
        cells.push({x,y,v:pct});
      });
    });

    new Chart(C('coverageHeatmap'),{
      type:'matrix',
      data:{
        datasets:[{
          label:'Coverage %',
          data: cells,
          width: ({chart}) => (chart.chartArea?.width || 0) / (coverage.crops.length+0.2),
          height:({chart}) => (chart.chartArea?.height|| 0) / (coverage.villages.length+0.2),
          backgroundColor: ctx => {
            const v = ctx.raw.v;
            if (v<40) return '#ff8a80';
            if (v<70) return '#ffd54f';
            return '#81c784';
          },
          borderWidth:1, borderColor:'#e5e7eb'
        }]
      },
      options:{
        responsive:true,
        plugins:{legend:{display:false}, tooltip:{callbacks:{title:(items)=> {
          const {x,y} = items[0].raw;
          return coverage.villages[y]+' ‚Ä¢ '+coverage.crops[x];
        }, label:(item)=> 'Coverage: '+item.raw.v+'%'}}},
        scales:{
          x:{type:'category', labels:coverage.crops, position:'top', grid:{display:false}},
          y:{type:'category', labels:coverage.villages, offset:true, grid:{display:false, drawBorder:false}}
        }
      }
    });
  }

  // 1b) Land owned vs financed
  if (C('landChart')) {
    new Chart(C('landChart'),{
      type:'bar',
      data:{labels:coverage.villages, datasets:[
        {label:'Owned (acres)',   data: landVsFinanced.owned,   backgroundColor:'#90caf9'},
        {label:'KCC-financed (acres)', data: landVsFinanced.financed, backgroundColor:'#1976d2'}
      ]},
      options:{responsive:true, plugins:{legend:{position:'top'}}, scales:{y:{beginAtZero:true}}},
      plugins:[valueLabelPlugin]
    });
    const gaps = coverage.villages
      .map((v,i)=>({v, gap: Math.max(0,landVsFinanced.owned[i]-landVsFinanced.financed[i])}))
      .sort((a,b)=>b.gap-a.gap);
    document.getElementById('landInsights').innerHTML =
      `‚Ä¢ Largest acreage gap in <b>${gaps[0].v}</b> (‚âà ${fmt(gaps[0].gap)} acres). Prioritise top-up drives.`;
  }

  // 2a) Term split
  if (C('termSplit')) {
    new Chart(C('termSplit'),{
      type:'doughnut',
      data:{labels:['KCC','MT','LT'], datasets:[{data:termSplit, backgroundColor:['#2e7d32','#1976d2','#6a4bc3']}]},
      options:{responsive:true, plugins:{legend:{position:'bottom'}}}
    });
  }

  // 2b) Kharif vs Rabi
  if (C('seasonSplit')) {
    new Chart(C('seasonSplit'),{
      type:'bar',
      data:{labels:seasonKCC.seasons, datasets:[
        {label:'KCC Disbursed (‚ÇπL)', data:seasonKCC.disbursed, backgroundColor:'#43a047'}
      ]},
      options:{responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}},
      plugins:[valueLabelPlugin]
    });
  }

  // 2c) Insurance coverage
  if (C('insuranceChart')) {
    new Chart(C('insuranceChart'),{
      type:'bar',
      data:{labels:insurance.crops, datasets:[
        {label:'Coverage %', data:insurance.coveragePct, backgroundColor: insurance.coveragePct.map(p=> p<70?'#ef5350':(p<90?'#ffb74d':'#66bb6a'))}
      ]},
      options:{responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true, max:100, ticks:{callback:v=>v+'%'}}}},
      plugins:[valueLabelPlugin]
    });
  }

  // 2d) Ticket sizes
  if (C('ticketChart')) {
    new Chart(C('ticketChart'),{
      type:'bar',
      data:{labels:ticketBuckets.labels, datasets:[
        {label:'# Loans', data:ticketBuckets.counts, backgroundColor:'#1565c0'}
      ]},
      options:{responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}},
      plugins:[valueLabelPlugin]
    });
  }

  // 2e) End use split
  if (C('endUseChart')) {
    new Chart(C('endUseChart'),{
      type:'pie',
      data:{labels:endUse.labels, datasets:[{data:endUse.shares, backgroundColor:['#2e7d32','#009688','#ffb300','#6a4bc3','#c62828']}]},
      options:{responsive:true, plugins:{legend:{position:'bottom'}}}
    });
  }

  // 3a) Cohort repayment (past)
  if (C('cohortRepay')) {
    new Chart(C('cohortRepay'),{
      type:'bar',
      data:{labels:cohort.labels, datasets:[
        {label:'On-time %', data:cohort.onTime, backgroundColor:'#2e7d32', stack:'s'},
        {label:'Delayed %', data:cohort.delayed, backgroundColor:'#ffb300', stack:'s'},
        {label:'Default %', data:cohort.defaulted, backgroundColor:'#c62828', stack:'s'}
      ]},
      options:{responsive:true, plugins:{legend:{position:'top'}}, scales:{y:{beginAtZero:true, max:100, ticks:{callback:v=>v+'%'}}}},
      plugins:[valueLabelPlugin]
    });
  }

  // 3b) To-be-due aging
  if (C('agingChart')) {
    new Chart(C('agingChart'),{
      type:'bar',
      data:{labels:aging.labels, datasets:[
        {label:'Amount (‚ÇπL)', data:aging.amountLakh, backgroundColor:'#1976d2'}
      ]},
      options:{responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}},
      plugins:[valueLabelPlugin]
    });
  }

  // 3c) DPD buckets (current)
  if (C('dpdBucketsChart')) {
    new Chart(C('dpdBucketsChart'),{
      type:'bar',
      data:{labels:dpdBuckets.labels, datasets:[
        {label:'Overdue (‚ÇπL)', data:dpdBuckets.amountLakh, backgroundColor:['#66bb6a','#ffb74d','#fb8c00','#c62828']}
      ]},
      options:{responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}},
      plugins:[valueLabelPlugin]
    });
  }

  // 3d) NPA nomenclature
  if (C('npaChart')) {
    new Chart(C('npaChart'),{
      type:'bar',
      data:{labels:npa.labels, datasets:[{label:'Outstanding (‚ÇπL)', data:npa.amountLakh, backgroundColor:'#6a4bc3'}]},
      options:{responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}},
      plugins:[valueLabelPlugin]
    });
  }

  // 4a) Concentration treemap
  if (C('concentrationTreemap')) {
    new Chart(C('concentrationTreemap'),{
      type:'treemap',
      data:{
        datasets:[{
          tree: concentration.data.map(d=>({category:d.name, value:d.share})),
          key:'value',
          labels:{display:true, formatter:ctx=> `${ctx.raw.category}\n${ctx.raw.value}%`},
          backgroundColor:(ctx)=>{
            const s = ctx.raw.value;
            return s>25 ? '#ef5350' : '#90caf9';
          },
          borderColor:'#fff', borderWidth:2, spacing:0.5
        }]
      },
      options:{responsive:true, plugins:{legend:{display:false}}}
    });
  }

  // 4b) Peer benchmarking (kept from your page, rebuilt)
  if (C('peerLoanChart')) {
    new Chart(C('peerLoanChart'),{
      type:'bar',
      data:{labels:peerVillages, datasets:[
        {label:'Avg ticket (‚Çπk)', data:avgTicket, backgroundColor:'#1976d2'},
        {type:'line', label:'Repayment %', data:repayPct, borderColor:'#2e7d32', pointRadius:4, tension:.35, yAxisID:'y1'}
      ]},
      options:{responsive:true, scales:{
        y:{beginAtZero:true, title:{display:true,text:'‚Çπ thousands'}},
        y1:{position:'right', beginAtZero:true, grid:{drawOnChartArea:false}, ticks:{callback:v=>v+' %'}, title:{display:true,text:'Repayment %'}}
      }},
      plugins:[valueLabelPlugin]
    });
  }

  /* ------ Page actions & CSVs ------ */
  const downloadCSV=(filename, rows)=>{
    const line = r=> r.map(v=>`"${(v??'').toString().replace(/"/g,'""')}"`).join(',');
    const csv = rows.map(line).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download=filename; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 500);
  };

  window.viewGapDetails = () => alert('Opens drill-down of underfinanced farmers for the selected village √ó crop (demo).');
  window.initiateMobilization = () => alert('Assign field officer & SMS campaign to red/amber cells (demo).');
  window.flagDataIssue = () => alert('Flagged the cell for data correction (demo).');
  window.recommendTopup = () => alert('Top-up recommendation generated for coverage gaps (demo).');

  window.exportCoverage = () => {
    const rows=[['Village','Crop','Coverage %']];
    coverage.villages.forEach((v,ri)=>{
      coverage.crops.forEach((c,ci)=> rows.push([v,c,coverage.matrix[ri][ci]]));
    });
    downloadCSV('coverage_heatmap.csv',rows);
  };
  window.chaseUninsured = () => alert('Generated list of uninsured KCC loans (demo).');
  window.exportInsurance = () => {
    const rows=[['Crop','Coverage %']]; insurance.crops.forEach((c,i)=>rows.push([c,insurance.coveragePct[i]]));
    downloadCSV('insurance_coverage.csv',rows);
  };
  window.sendReminders = () => alert('Reminder SMS/WA queued (demo).');
  window.downloadDueList = () => {
    const rows=[['Bucket','Amount (‚ÇπL)']]; aging.labels.forEach((b,i)=>rows.push([b,aging.amountLakh[i]]));
    downloadCSV('to_be_due_aging.csv',rows);
  };
  window.escalate90 = () => alert('Escalation note prepared for >90 DPD (demo).');
  window.exportDPD = () => {
    const rows=[['DPD Bucket','Amount (‚ÇπL)']]; dpdBuckets.labels.forEach((b,i)=>rows.push([b,dpdBuckets.amountLakh[i]]));
    downloadCSV('dpd_buckets.csv',rows);
  };
  window.downloadPeerLoan = () => {
    const rows=[['Peer','Avg ticket (‚Çπk)','Repayment %']]; peerVillages.forEach((p,i)=>rows.push([p,avgTicket[i],repayPct[i]]));
    downloadCSV('peer_benchmarking.csv',rows);
  };
  window.setTargets = () => alert('Targets set for low-performing peers/villages (demo).');
</script>
</body>
</html>
